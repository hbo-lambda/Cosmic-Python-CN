
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../q.Dependency%20Injection/">
      
      
        <link rel="next" href="../s.Appendix%20A/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>结语 - My Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bcfcd587.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="My Docs" class="md-header__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            My Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              结语
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="My Docs" class="md-nav__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    My Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    REAMDME
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../a.Preface/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    前言
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../b.Introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    介绍
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../c.Part1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一部分: 构建支持领域建模的架构
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../d.Domain%20Modeling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.领域建模
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../e.Repository%20Pattern/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.存储库模式
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../f.Coupling%20and%20Abstractions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.简短插曲：耦合和抽象
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../g.Flask%20API%20and%20Service%20Layer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.我们的第一个用例：Flask API和服务层
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../h.TDD%20in%20High%20Gear%20and%20Low%20Gear/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5.TDD高速和低速
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../i.Unit%20of%20Work%20Pattern/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6.工作单元模式
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../j.aggregates%20and%20Consistency%20Boundaries/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7.聚合和一致性边界
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../k.Part2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二部分 事件驱动架构
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../l.Events%20and%20the%20Message%20Bus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8.事件和消息总线
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../m.Going%20to%20Town%20on%20the%20Message%20Bus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9.使用消息总线大干一场
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../n.Commands%20and%20Command%20Handler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10.命令和命令处理程序
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../o.Event-Driven%20Architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11.事件驱动架构：使用事件集成微服务
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../p.CQRS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12.命令查询职责分离
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../q.Dependency%20Injection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    13.依赖注入（和引导）
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    结语
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    结语
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      现在怎么办？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      我该如何从这里到达那里？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      分离纠缠的责任
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      识别聚合和有界上下文
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      说服你的利益相关者尝试新事物
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      我们的技术评论员提出的问题我们无法用散文形式表达出来
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      步枪（翻译的不合适）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      更多必读内容
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../s.Appendix%20A/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    附录A：摘要图表
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../t.Appendix%20B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    附录B：模板项目结构
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../u.Appendix%20C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    附录C：更换基础设施：用csv完成所有工作
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../v.Appendix%20D/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    附录D：Django 的存储库和工作单元模式
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../w.Appendix%20E/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    附录E：验证
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      现在怎么办？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      我该如何从这里到达那里？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      分离纠缠的责任
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      识别聚合和有界上下文
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      说服你的利益相关者尝试新事物
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      我们的技术评论员提出的问题我们无法用散文形式表达出来
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      步枪（翻译的不合适）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      更多必读内容
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="_1">结语</h1>
<h2 id="_2"><font color='red'>现在怎么办？</font></h2>
<p>呼！我们在这本书中已经涵盖了很多内容，对于我们的大多数读者来说，所有这些想法都是新的。考虑到这一点，我们不能指望让您成为这些技术的专家。我们真正能做的就是向您展示粗略的想法，以及足够的代码，让您继续从头开始编写一些东西。</p>
<p>我们在本书中展示的代码并不是久经沙场的生产代码：它是一组乐高积木，你可以用它搭建你的第一栋房子、宇宙飞船和摩天大楼。</p>
<p>这给我们留下了两个大任务。我们想谈谈如何在现有系统中真正应用这些想法，并且我们需要警告你一些我们不得不跳过的事情。我们给了你一整套新的自找麻烦的方法，所以我们应该讨论一些基本的武器安全问题。</p>
<h2 id="_3"><font color='red'>我该如何从这里到达那里？</font></h2>
<p>很多人可能正在考虑这样的事情：</p>
<p>“好吧，Bob和Harry，一切都很好，如果我被雇用来开发一项全新的服务，我知道该怎么做。但与此同时，我在这里，带着一团巨大的 Django 泥球，我看不出有任何方法可以实现你们漂亮、干净、完美、纯洁、简单的模型。从这里不行。”</p>
<p>我们理解你的想法。一旦你已经积攒了一大堆泥球，就很难知道如何开始改善事情。真的，我们需要一步一步地解决问题。</p>
<p>首先要考虑的是：您要解决什么问题？软件是否太难更改？性能是否不可接受？您是否遇到了奇怪、无法解释的错误？</p>
<p>心中有明确的目标将有助于您确定需要完成的工作的优先顺序，更重要的是，向团队其他成员传达完成工作的原因。只要工程师能够提出合理的理由来解决问题，企业往往会采取务实的方式来处理技术债务和重构。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>如果将对系统的复杂更改与功能工作联系起来，通常更容易让人接受。也许您正在推出新产品或向新市场开放服务？这是投入工程资源修复基础的最佳时机。由于要交付为期六个月的项目，因此更容易提出三周的清理工作。Bob 将此称为架构税。</p>
</div>
<h2 id="_4"><font color='red'>分离纠缠的责任</font></h2>
<p>在本书的开头，我们说过，大泥球的主要特征是同质性：系统的每个部分看起来都一样，因为我们还没有明确每个组件的职责。为了解决这个问题，我们需要开始分离职责并引入明确的界限。我们可以做的第一件事之一就是开始构建服务层（图1.协作系统领域）。</p>
<figure>
    <img align="center" alt="" src="https://read-code.oss-cn-beijing.aliyuncs.com/apwp_ep01.png" />
    <figcaption><font size=2></font>图1.协作系统领域</figcaption>
</figure>
<p>正是在这个系统中，Bob第一次学会了如何分解泥球，这真是太神奇了。逻辑无处不在——在网页中、在管理器对象中、在助手中、在我们为抽象管理器和助手而编写的肥胖服务类中，以及在我们为分解服务而编写的复杂命令对象中。</p>
<p>如果你在已经达到这个地步的系统下工作，情况可能会让人感到绝望，但开始除草杂草丛生的花园永远不会太晚。最后，我们聘请了一位知道自己在做什么的建筑师，他帮助我们把事情控制住了。</p>
<p>首先确定系统的用例。如果您有用户界面，它会执行哪些操作？如果您有后端处理组件，也许每个 <code>cron</code> 作业或 <code>Celery</code> 作业都是一个用例。每个用例都需要有一个命令式名称：例如，应用账单费用、清理废弃帐户或提交采购订单。</p>
<p>在我们的案例中，大多数用例都是管理器类的一部分，并具有“创建工作区”或“删除文档版本”等名称。每个用例都是从 Web 前端调用的。</p>
<p>我们的目标是为每个支持的操作创建一个单独的函数或类，用于协调要完成的工作。每个用例都应执行以下操作：</p>
<ul>
<li>如果需要，启动自己的数据库事务</li>
<li>获取任何所需数据</li>
<li>检查所有先决条件（参见<a href="../w.Appendix%20E/">附录E 验证</a>中的确保模式）</li>
<li>更新领域模型</li>
<li>保留所有更改</li>
</ul>
<p>每个用例都应作为一个原子单位成功或失败。您可能需要从一个用例调用另一个用例。没关系；只需记下来，并尽量避免长时间运行的数据库事务。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>我们遇到的最大问题之一是管理器方法调用其他管理器方法，并且数据访问可能来自模型对象本身。如果不在代码库中寻找宝藏，很难理解每个操作的作用。将所有逻辑拉到一个方法中，并使用 UoW 来控制我们的事务，使系统更容易推理。</p>
</div>
<div style="border:1px solid #e0e0dc;background:#f8f8f7;padding:15px;">
<p align='center'><strong style='font-size:1.6em;color:#186d7a'>案例研究：对过度发展的系统进行分层</strong></p>
<p>许多年前，Bob曾在一家软件公司工作，该公司将其应用程序的第一个版本外包出去，这是一个用于共享和处理文件的在线协作平台。</p>
<p>当公司将开发纳入内部时，它经过了好几代开发人员之手，每一波新开发人员都会增加代码结构的复杂性。</p>
<p>该系统的核心是一个使用 NHibernate ORM 构建的 ASP.NET Web 表单应用程序。用户可以将文档上传到工作区，然后邀请其他工作区成员审阅、评论或修改他们的工作。</p>
<p>应用程序的大部分复杂性在于权限模型，因为每个文档都包含在一个文件夹中，并且文件夹允许读取、写入和编辑权限，就像 Linux 文件系统一样。</p>
<p>此外，每个工作区都属于一个帐户，并且该帐户通过计费包附加有配额。</p>
<p>因此，每次对文档的读取或写入操作都必须从数据库加载大量对象，以测试权限和配额。创建新工作区涉及数百个数据库查询，因为我们要设置权限结构、邀请用户并设置示例内容。</p>
<p>部分操作代码位于用户单击按钮或提交表单时运行的 Web 处理程序中；部分位于包含用于协调工作的代码的管理器对象中；部分位于域模型中。模型对象会进行数据库调用或复制磁盘上的文件，测试覆盖率极低。</p>
<p>为了解决这个问题，我们首先引入了一个服务层，以便创建文档或工作区的所有代码都集中在一个地方，并且可以理解。这涉及将数据访问代码从域模型中提取出来并放入命令处理程序中。同样，我们将编排代码从管理器和 Web 处理程序中提取出来并将其推送到处理程序中。</p>
<p>最终的命令处理程序又长又乱，但我们已开始在混乱中引入秩序。</p>
</div>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>如果用例函数中有重复，那也没关系。我们并不是想写出完美的代码；我们只是想提取一些有意义的层。最好在几个地方重复一些代码，而不是让用例函数在长链中相互调用。</p>
</div>
<p>这是将任何数据访问或编排代码从域模型中拉出并放入用例的好机会。我们还应该尝试将 I/O 问题（例如，发送电子邮件、写入文件）从域模型中拉出并放入用例函数中。我们将<a href="../f.Coupling%20and%20Abstractions/">3.耦合和抽象</a>中的技术应用于抽象，以使我们的处理程序即使在执行 I/O 时也能进行单元测试。</p>
<p>这些用例函数主要涉及日志记录、数据访问和错误处理。完成此步骤后，您将了解程序实际执行的操作，并知道如何确保每个操作都有明确定义的开始和结束。我们将朝着构建纯域模型迈出一步。</p>
<p>阅读Michael C. Feathers (Prentice Hall) 撰写的《有效地使用遗留代码》以获得有关对遗留代码进行测试和开始分离职责的指导。</p>
<h2 id="_5"><font color='red'>识别聚合和有界上下文</font></h2>
<p>我们案例研究中的代码库存在的问题之一是对象图高度关联。每个帐户都有许多工作区，每个工作区都有许多成员，所有成员都有自己的帐户。每个工作区都包含许多文档，这些文档有许多版本。</p>
<p>您无法用类图来表达这件事的全部恐怖之处。首先，实际上没有一个与用户相关的帐户。相反，有一个奇怪的规则要求您通过工作区枚举与用户相关的所有帐户，并选取创建日期最早的帐户。</p>
<p>系统中的每个对象都是包含<code>SecureObject</code>和的继承层次结构的一部分Version。此继承层次结构直接镜像到数据库模式中，因此每个查询都必须跨 10 个不同的表进行连接，并查看鉴别器列，才能知道您正在处理哪种对象。</p>
<p>代码库让你可以轻松地通过这些对象来做到这一点，就像这样：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>user.account.workspaces[0].documents.versions[1].owner.account.settings[0];
</span></code></pre></div>
<p>使用 Django ORM 或 SQLAlchemy 以这种方式构建系统很容易，但应避免。虽然这很方便，但它很难推断性能，因为每个属性都可能触发对数据库的查找。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>聚合是一致性的边界。一般来说，每个用例应该一次更新一个聚合。一个处理程序从存储库中获取一个聚合，修改其状态，并引发由此发生的任何事件。如果您需要系统其他部分的数据，使用读取模型是完全可以的，但要避免在单个事务中更新多个聚合。当我们选择将代码分成不同的聚合时，我们明确选择使它们最终彼此一致。</p>
</div>
<p>一系列操作需要我们以这种方式循环对象 - 例如：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a># Lock a user&#39;s workspaces for nonpayment
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>def lock_account(user):
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    for workspace in user.account.workspaces:
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>        workspace.archive()
</span></code></pre></div>
<p>甚至可以递归文件夹和文档的集合：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>def lock_documents_in_folder(folder):
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    for doc in folder.documents:
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>         doc.archive()
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>     for child in folder.children:
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>         lock_documents_in_folder(child)
</span></code></pre></div>
<p>这些操作会降低性能，但修复它们意味着放弃我们的单对象图。相反，我们开始识别聚合并打破对象之间的直接联系。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>我们讨论了<a href="../p.CQRS/">12.CQRS</a> <code>SELECT N+1</code> 中臭名昭著的问题，以及如何选择在读取查询数据和读取命令数据时使用不同的技术。</p>
</div>
<p>我们主要通过用标识符替换直接引用来实现这一点。</p>
<p>聚合之前：</p>
<figure>
    <img align="center" alt="" src="https://read-code.oss-cn-beijing.aliyuncs.com/apwp_ep02.png" />
    <figcaption><font size=2></font></figcaption>
</figure>
<p>使用聚合建模后：</p>
<figure>
    <img align="center" alt="" src="https://read-code.oss-cn-beijing.aliyuncs.com/apwp_ep03.png" />
    <figcaption><font size=2></font></figcaption>
</figure>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>双向链接通常表明您的聚合不正确。在我们的原始代码中， <code>Document</code>知道它所在<code>Folder</code>，而<code>Folder</code>有<code>Documents</code>的集合。这使得遍历对象图变得容易，但阻止我们正确思考所需的一致性边界。我们改用引用来分解聚合。在新模型中， <code>Document</code>有对<code>parent_folder</code>的引用，但无法直接访问<code>Folder</code>。</p>
</div>
<p>如果我们需要读取数据，我们会避免编写复杂的循环和转换，并尝试用直接的 SQL 来代替它们。例如，我们的一个屏幕是文件夹和文档的树形视图。</p>
<p>这个屏幕对数据库的 要求非常for高，因为它依赖于触发延迟加载 ORM 的嵌套循环。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>我们在<a href="../p.CQRS/">12.CQRS</a> 中使用了同样的技术，用简单的 SQL 查询替换了 ORM 对象上的嵌套循环。这是 CQRS 方法的第一步。</p>
</div>
<p>经过一番苦思冥想，我们用一个又大又丑的存储过程替换了 ORM 代码。代码看起来很糟糕，但速度更快，并且有助于打破<code>Folder</code>和<code>Document</code>之间的联系。</p>
<p>当我们需要写入数据时，我们一次更改一个聚合，并引入了消息总线来处理事件。例如，在新模型中，当我们锁定帐户时，我们可以首先通过<code>SELECT id FROM workspace WHERE account_id = ?</code>查询所有受影响的工作区 。</p>
<p>然后我们可以为每个工作区发出一个新命令：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>for workspace_id in workspaces:
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    bus.handle(LockWorkspace(workspace_id))
</span></code></pre></div>
<p>通过 Strangler 模式实现微服务的事件驱动方法
Strangler Fig模式涉及在旧系统的边缘创建一个新系统，同时保持其运行。旧功能的片段被逐渐拦截和替换，直到旧系统完全不工作并且可以关闭。</p>
<p>在构建可用性服务时，我们使用了一种称为事件拦截的技术将功能从一个地方移动到另一个地方。这是一个三步过程：</p>
<ol>
<li>引发事件来表示您想要替换的系统中正在发生的变化。</li>
<li>构建第二个系统，使用那些事件并使用它们来构建自己的领域模型。</li>
<li>用新系统替换旧系统。</li>
</ol>
<p>我们使用事件拦截从 图2.之前基于 XML-RPC 的强双向耦合……</p>
<figure>
    <img align="center" alt="" src="https://read-code.oss-cn-beijing.aliyuncs.com/apwp_ep04.png" />
    <figcaption><font size=2>图2.之前基于 XML-RPC 的强双向耦合</font></figcaption>
</figure>
<p>到 图3.之后：与异步事件的松散耦合（你可以在 cosmicpython.com 找到该图的高分辨率版本）。</p>
<figure>
    <img align="center" alt="" src="https://read-code.oss-cn-beijing.aliyuncs.com/apwp_ep05.png" />
    <figcaption><font size=2>图3.之后：与异步事件的松散耦合（你可以在 cosmicpython.com 找到该图的高分辨率版本）</font></figcaption>
</figure>
<p>实际上，这是一个持续数月的项目。我们的第一步是编写一个可以表示批次、装运和产品的领域模型。我们使用 TDD 构建了一个可以回答一个问题的玩具系统：“如果我想要 N 个 HAZARDOUS_RUG单位，它们需要多长时间才能送达？”</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>部署事件驱动系统时，要从“行走骨架”开始。部署仅记录其输入的系统迫使我们解决所有基础设施问题并开始投入生产。</p>
</div>
<div style="border:1px solid #e0e0dc;background:#f8f8f7;padding:15px;">
<p align='center'><strong style='font-size:1.6em;color:#186d7a'>案例研究：开发微服务来取代域</strong></p>
<p>MADE.com 最初由两个整体组成：一个用于前端电子商务应用程序，一个用于后端履行系统。</p>
<p>两个系统通过 XML-RPC 进行通信。后端系统会定期唤醒并查询前端系统以了解新订单。当它导入了所有新订单后，它会发送 RPC 命令来更新库存水平。</p>
<p>随着时间的推移，这个同步过程变得越来越慢，直到有一年圣诞节，导入一天的订单需要超过 24 小时。Bob 被聘用将系统分解为一组事件驱动的服务。</p>
<p>首先，我们发现流程中最慢的部分是计算和同步可用库存。我们需要一个可以监听外部事件并持续监控可用库存总量的系统。</p>
<p>我们通过 API 公开该信息，以便用户的浏览器可以询问每种产品有多少库存以及需要多长时间才能送到他们的地址。</p>
<p>每当某种产品完全缺货时，我们就会触发一个新事件，电商平台可以利用该事件来下架该产品。由于我们不知道需要处理多少负载，因此我们采用 CQRS 模式编写了系统。每当库存量发生变化时，我们都会使用缓存的视图模型更新 Redis 数据库。我们的 Flask API 查询这些视图模型，而不是运行复杂的域模型。</p>
<p>因此，我们可以在 2 到 3 毫秒内回答“有多少库存？”的问题，并且现在 API 经常会在较长时间内每秒处理数百个请求。</p>
<p>如果这一切听起来有点熟悉，那么，现在您知道我们的示例应用程序来自哪里了！</p>
</div>

<p>一旦我们有了可行领域模型，我们就开始构建一些基础架构。我们的第一个生产部署是一个可以接收<code>batch_created</code>事件并记录其 <code>JSON</code> 的小型系统。这是事件驱动架构的“Hello World”。它迫使我们部署消息总线、连接生产者和消费者、构建部署管道并编写一个简单的消息处理程序。</p>
<p>有了部署管道、所需的基础设施和基本领域模型，我们就可以开始了。几个月后，我们开始投入生产并为真正的客户提供服务。</p>
<h2 id="_6"><font color='red'>说服你的利益相关者尝试新事物</font></h2>
<p>如果您正在考虑从一大堆泥土中创造一个新系统，那么您可能会遇到可靠性、性能、可维护性或同时遇到这三个问题。深层次的棘手问题需要采取严厉措施！</p>
<p>我们建议首先进行领域建模。在许多过度发展的系统中，工程师、产品所有者和客户不再使用同一种语言。业务利益相关者以抽象、以流程为中心的术语谈论系统，而开发人员则被迫谈论系统在野蛮混乱状态下的物理存在。</p>
<div style="border:1px solid #e0e0dc;background:#f8f8f7;padding:15px;">
<p align='center'><strong style='font-size:1.6em;color:#186d7a'>案例研究：用户模型</strong></p>
<p>我们之前提到，我们的第一个系统中的帐户和用户模型被一条“奇怪的规则”绑定在一起。这是工程和业务利益相关者如何分道扬镳的完美例子。</p>
<p>在这个系统中，账户是工作区的父级，用户是工作区的成员。工作区是应用权限和配额的基本单位。如果用户加入了工作区但还没有账户，我们会将他们与拥有该工作区的账户关联起来。</p>
<p>这是混乱和临时的，但它工作得很好，直到有一天产品负责人要求增加一个新功能：</p>
<quote>“当用户加入公司时，我们希望将他们添加到公司的一些默认工作区中，例如人力资源工作区或公司公告工作区。”</quote>
<p>我们不得不向他们解释，公司根本不存在，用户加入账户也毫无意义。此外，“公司”可能拥有 多个账户，由不同的用户拥有，新用户可能会被邀请加入其中任何一个账户。</p>
<p>多年来，我们一直在对一个有缺陷的模型进行各种修改和变通，最终我们不得不将整个用户管理功能重写为一个全新的系统。</p>
</div>

<p>弄清楚如何为您的领域建模是一项复杂的任务，它本身就是许多优秀书籍的主题。我们喜欢使用事件风暴和 CRC 建模等交互式技术，因为人类擅长通过游戏进行协作。事件建模是另一种技术，它让工程师和产品所有者一起从命令、查询和事件的角度了解系统。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>请访问www.eventmodeling.org和www.eventstorming.com获取有关使用事件对系统进行可视化建模的一些出色指南。</p>
</div>
<p>目标是能够使用相同的通用语言来讨论系统，以便您能够就复杂性所在达成一致。</p>
<p>我们发现将领域问题视为 TDD Kata 具有很大的价值。例如，我们为可用性服务编写的第一个代码是批处理和订单行模型。您可以将其视为午餐时间研讨会，或项目开始时的高峰。一旦您能够证明建模的价值，就更容易提出构建项目以优化建模的论点。</p>
<div style="border:1px solid #e0e0dc;background:#f8f8f7;padding:15px">
    <p align='center'><strong style='font-size:1.6em;color:#186d7a'>案例研究：David Seddon 谈如何迈出小步</strong></p>
    <p>大家好，我是 David，本书的技术评论员之一。我曾参与过多个复杂的 Django 单体项目，所以我知道 Bob 和 Harry 曾许诺要减轻这些痛苦。</p>
    <p>当我第一次接触到这里描述的模式时，我非常兴奋。我已经在较小的项目中成功使用了一些技术，但这是一个更大的、由数据库支持的系统的蓝图，就像我在日常工作中使用的系统一样。所以我开始试图弄清楚如何在我目前的组织中实施这个蓝图。</p>
    <p>我选择解决代码库中一直困扰我的一个问题区域。我首先将其作为用例实现。但我发现自己遇到了意想不到的问题。有些事情我在阅读时没有考虑到，现在很难知道该怎么做。如果我的用例与两个不同的聚合交互，这会是个问题吗？一个用例可以调用另一个用例吗？它将如何存在于遵循不同架构原则的系统中而不会导致可怕的混乱？</p>
    <p>那份充满希望的蓝图到哪里去了？我是否真的充分理解了这些想法，并将它们付诸实践？它是否适合我的应用？即使适合，我的同事中会有人同意这么大的改变吗？这些只是我在现实生活中幻想的美好想法吗？</p>
    <p>我花了一段时间才意识到我可以从小事做起。我不需要成为一个纯粹主义者，也不需要“第一次就做对”：我可以尝试，找到适合我的方法。</p>
    <p>这就是我所做的。我已经能够在一些地方应用一些想法。我构建了新功能，其业务逻辑可以在没有数据库或模拟的情况下进行测试。作为一个团队，我们引入了一个服务层来帮助定义系统所做的工作。</p>
    <p>如果你开始尝试在工作中应用这些模式，一开始你可能会有类似的感觉。当书中的精彩理论与你的代码库的现实相遇时，可能会令人沮丧。</p>
    <p>我的建议是专注于一个特定的问题，并问问自己如何将相关的想法付诸实践，也许一开始的方式是有限的和不完美的。你可能会像我一样发现，你选择的第一个问题可能有点太难了；如果是这样，那就换个问题吧。不要试图把大海煮沸，也不要太害怕 犯错。这将是一次学习经历，你可以确信你正在朝着别人认为有用的方向前进。</p>
    <p>所以，如果你也感受到痛苦，那就试试这些想法吧。不要觉得你需要获得许可才能重新构建一切。只需从小处着手即可。最重要的是，这样做是为了解决一个特定的问题。如果你成功解决了这个问题，你就会知道你做对了——其他人也会知道。</p>
</div>

<h2 id="_7"><font color='red'>我们的技术评论员提出的问题我们无法用散文形式表达出来</font></h2>
<p>以下是我们在起草过程中听到的一些问题，但在本书的其他地方找不到合适的地方来解答：</p>
<p><strong>我需要一次性完成所有任务吗？我可以一次只做一点吗？</strong>
不，您完全可以一点一点地采用这些技术。如果您有现有系统，我们建议您构建一个服务层，以尝试将编排集中在一个地方。一旦您有了这个，就可以更轻松地将逻辑推送到模型中，并将验证或错误处理等边缘问题推送到入口点。</p>
<p>即使您仍然拥有庞大、混乱的 Django ORM，也值得拥有一个服务层，因为它是开始理解操作边界的一种方法。</p>
<p><strong>提取用例会破坏我现有的很多代码；它太复杂了</strong></p>
<p>只需复制并粘贴。短期内造成更多重复是可以的。将其视为一个多步骤过程。您的代码现在处于糟糕的状态，因此请将其复制并粘贴到新位置，然后使新代码干净整洁。</p>
<p>完成此操作后，您可以用对新代码的调用替换旧代码的使用，并最终消除混乱。修复大型代码库是一个混乱而痛苦的过程。不要指望事情会立即好转，也不要担心应用程序的某些部分是否仍然混乱。</p>
<p><strong>我需要做 CQRS 吗？这听起来很奇怪。我不能只使用存储库吗？</strong></p>
<p>当然可以！我们在本书中介绍的技术旨在让您的生活更轻松。它们不是用来惩罚自己的苦行僧。</p>
<p>在工作区/文档案例研究系统中，我们有很多View Builder对象，它们使用存储库来获取数据，然后执行一些转换以返回哑读模型。这样做的好处是，当您遇到性能问题时，可以轻松重写视图构建器以使用自定义查询或原始 SQL。</p>
<p><strong>用例应如何在大型系统中交互？一个用例调用另一个用例会不会有问题？</strong></p>
<p>这可能是一个临时步骤。同样，在文档案例研究中，我们的处理程序需要调用其他处理程序。不过，这会变得非常混乱，最好使用消息总线来分离这些问题。</p>
<p>通常，您的系统将有一个消息总线实现和一组以特定聚合或聚合集为中心的子域。当您的用例完成后，它可以引发事件，并且其他地方的处理程序可以运行。</p>
<p><strong>对于使用多个存储库/聚合的用例来说，这是否存在代码异味？如果是，为什么？</strong></p>
<p>聚合是一致性边界，因此如果您的用例需要原子地更新两个聚合（在同一事务内），那么严格来说，您的一致性边界是错误的。理想情况下，您应该考虑转移到一个新的聚合，该聚合可以同时包装您想要更改的所有内容。</p>
<p>如果您实际上只更新一个聚合并使用其他聚合进行只读访问，那么没问题，尽管您可以考虑构建一个读取/视图模型来获取该数据 - 如果每个用例只有一个聚合，它会使事情变得更清晰。</p>
<p>如果您确实需要修改两个聚合，但这两个操作不必位于同一事务/工作单位 (UoW) 中，那么请考虑将工作拆分为两个不同的处理程序，并使用域事件在两者之间传递信息。您可以在Vaughn Vernon 撰写的有关聚合设计的论文中阅读更多内容。</p>
<p><strong>如果我有一个只读但业务逻辑繁重的系统怎么办？</strong></p>
<p>视图模型中可能包含复杂的逻辑。在本书中，我们鼓励您将读取和写入模型分开，因为它们具有不同的一致性和吞吐量要求。大多数情况下，我们可以对读取使用更简单的逻辑，但这并不总是正确的。特别是，权限和授权模型会给我们的读取端增加很多复杂性。</p>
<p>我们编写了视图模型需要大量单元测试的系统。在这些系统中，我们将视图构建器与视图获取器分开，如图4.视图构建器和视图获取器（您可以在 cosmicpython.com 上找到此图的高分辨率版本）。</p>
<figure>
    <img align="center" alt="" src="https://read-code.oss-cn-beijing.aliyuncs.com/apwp_ep06.png" />
    <figcaption><font size=2>图4.视图构建器和视图获取器（您可以在 cosmicpython.com 上找到此图的高分辨率版本）</font></figcaption>
</figure>
<ul>
<li>通过向视图构建器提供模拟数据（例如，字典列表），可以轻松测试视图构建器。带有事件处理程序的“花式 CQRS”实际上是一种在我们写入时运行复杂视图逻辑的方法，这样我们就可以避免在读取时运行它。</li>
</ul>
<p><strong>我需要构建微服务来完成这些工作吗？</strong></p>
<p>天哪，不！这些技术比微服务早了大约十年。聚合、域事件和依赖反转是控制大型系统复杂性的方法。碰巧的是，当您为业务流程构建了一组用例和模型时，将其移动到自己的服务相对容易，但这不是必需的。</p>
<p><strong>我正在使用 Django。我还能这样做吗？</strong>
我们为您准备了完整的附录：<a href="../v.Appendix%20D/">附录D Django</a>！</p>
<h2 id="_8"><font color='red'>步枪（翻译的不合适）</font></h2>
<p>好的，我们为您提供了一大堆新玩具。以下是细则。Harry 和 Bob 不建议您将我们的代码复制并粘贴到生产系统中，并在 Redis 发布/订阅上重建您的自动交易平台。为了简洁起见，我们忽略了许多棘手的问题。以下是我们认为您在真正尝试之前应该了解的事项列表。</p>
<p><strong>可靠的消息传递很难</strong></p>
<p>Redis 发布/订阅不可靠，不应用作通用消息传递工具。我们之所以选择它是因为它很熟悉且易于运行。在 MADE，我们运行 Event Store 作为消息传递工具，但我们也有使用 RabbitMQ 和 Amazon EventBridge 的经验。</p>
<p>Tyler Treat 在他的网站bravenewgeek.com上发表了一些很棒的博客文章；你至少应该读一读“<a href="https://bravenewgeek.com/you-cannot-have-exactly-once-delivery/">你无法进行一次性交付</a>” 和“<a href="https://bravenewgeek.com/what-you-want-is-what-you-dont-understanding-trade-offs-in-distributed-messaging/">你想要的是你不想要的：理解分布式消息传递中的权衡</a>”。</p>
<p><strong>我们明确选择小型的、集中的、可以独立失败的事务</strong></p>
<p>在<a href="../l.Events%20and%20the%20Message%20Bus/">8.事件和消息总线</a>中，我们更新了流程，以便取消分配订单行和重新分配订单行在两个单独的工作单元中进行。您需要监控以了解这些事务何时失败，以及使用工具来重播事件。通过使用事务日志作为消息代理（例如 Kafka 或EventStore ） ，其中一些操作会变得更容易。您也可以查看 <a href="https://microservices.io/patterns/data/transactional-outbox.html">Outbox</a> 模式。</p>
<p><strong>我们不讨论幂等性</strong></p>
<p>我们还没有真正考虑过重试处理程序时会发生什么。实际上，您需要使处理程序具有幂等性，以便使用相同消息重复调用它们不会重复更改状态。这是构建可靠性的关键技术，因为它使我们能够在事件失败时安全地重试事件。</p>
<p>关于幂等消息处理有很多好的材料，尝试从“<a href="https://blog.sapiensworks.com/post/2015/08/26/How-To-Ensure-Idempotency">如何在最终一致的 DDD/CQRS 应用程序中确保幂等性</a>”和“<a href="https://lostechies.com/jimmybogard/2013/06/03/un-reliability-in-messaging-idempotency-and-de-duplication/">消息传递中的（不）可靠性</a>”开始。</p>
<p><strong>随着时间的推移，您的事件需要改变它们的模式</strong></p>
<p>您需要找到某种方法来记录您的事件并与消费者分享其中的模式。我们喜欢使用 <code>JSON</code> 和 <code>markdown</code>，因为它很简单，但还有其他现有技术。Greg Young 写了一本关于随时间管理事件驱动系统的书：事件源系统中的版本控制(Leanpub)。</p>
<h2 id="_9"><font color='red'>更多必读内容</font></h2>
<p>我们还想推荐几本可以帮助你的书籍：
- Leonardo Giordani (Leanpub) 于 2019 年出版的《Python 中的清晰架构》是之前为数不多的关于 Python 应用程序架构的书籍之一。
- Gregor Hohpe 和 Bobby Woolf（Addison-Wesley Professional）编写的《企业集成模式》对于消息传递模式来说是一个很好的开端。
- Sam Newman 的《整体架构到微服务》（O'Reilly）和 Newman 的第一本书《微服务设计》（O'Reilly）。Strangler Fig 模式和许多其他模式被列为最受欢迎的模式。如果您正在考虑转向微服务，这些书值得一看，它们在集成模式和基于异步消息的集成方面的考虑也很不错。</p>
<h2 id="_10"><font color='red'>总结</font></h2>
<p>呼！这可真是太多警告和阅读建议了；我们希望我们没有完全吓跑你。我们写这本书的目的是给你足够的知识和直觉，让你开始为自己构建一些内容。我们很想听听你的进展如何，以及你在自己的系统中遇到的技术问题，所以为什么不通过www.cosmicpython.com与我们联系呢？</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>